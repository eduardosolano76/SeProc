<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Módulo Admin</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
	rel="stylesheet">

<style>
:root {
	--orange: #c66a00;
	--orange-2: #b55f00;
	--active: #7a6049;
	--bg: #ffffff;
	--panel: #eceae6;
	--text: #111;
	--muted: #6c6c6c;
	--radius: 34px;
}

* {
	box-sizing: border-box;
}

html, body {
	height: 100%;
}

body {
	margin: 0;
	font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto,
		Arial, sans-serif;
	background: var(--bg);
	color: var(--text);
}

/* ===== Layout ===== */
.layout {
	display: flex;
	min-height: 100vh;
	width: 100%;
}

/* ===== Sidebar ===== */
.sidebar {
	width: 300px;
	background: var(--orange);
	padding: 26px 0;
	display: flex;
	flex-direction: column;
	gap: 22px;
	position: relative;
}

.brand {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 14px;
	padding: 0 18px;
}

/* Tamaño del logo */
.brand .logo {
	width: 130px;
	height: 130px;
	border-radius: 50%;
	background: #fff;
	overflow: hidden;
	border: 6px solid #fff;
	outline: 4px solid rgba(255, 255, 255, .25);
	box-shadow: 0 10px 26px rgba(0, 0, 0, .18);
	display: grid;
	place-items: center;
}

.brand .logo img {
	width: 100%;
	height: 100%;
	object-fit: cover;
	display: block;
}

/* Top móvil dentro del sidebar botón ☰ */
.mobile-top {
	display: none;
	padding: 0 14px;
	width: 100%;
	justify-content: flex-end;
}

.hamburger {
	border: none;
	background: rgba(255, 255, 255, .18);
	color: #fff;
	width: 44px;
	height: 44px;
	border-radius: 12px;
	font-size: 22px;
	cursor: pointer;
}

.hamburger:active {
	transform: translateY(1px);
}

.nav {
	margin-top: 12px;
	display: flex;
	flex-direction: column;
	gap: 8px;
}

.nav-item {
	width: 100%;
	border: none;
	background: transparent;
	color: #fff;
	text-align: left;
	padding: 16px 18px;
	cursor: pointer;
	display: flex;
	align-items: center;
	gap: 14px;
	font-size: 18px;
	border-radius: 0;
	transition: background .15s ease;
	line-height: 1;
}

.nav-item:hover {
	background: var(--active);
}

.nav-item.active {
	background: var(--active);
}

.nav-item .icon {
	width: 28px;
	height: 28px;
	display: flex;
	align-items: center;
	justify-content: center;
	flex: 0 0 28px;
}

.nav-item .icon img {
	width: 26px;
	height: 26px;
	object-fit: contain;
	display: block;
	filter: brightness(0) invert(1);
	transform: translateY(1px);
}

.nav-item .label {
	flex: 1;
	font-weight: 500;
}

.nav-item .chev {
	width: 18px;
	height: 18px;
	display: flex;
	align-items: center;
	justify-content: center;
	opacity: .9;
	transition: transform .15s ease;
}

.nav-item .chev img {
	width: 16px;
	height: 16px;
	object-fit: contain;
	filter: brightness(0) invert(1);
	transform: translateY(1px);
}

.nav-item[data-open="true"] .chev {
	transform: rotate(180deg);
}

/* ===== Submenu ===== */
.submenu {
	display: none;
	flex-direction: column;
	gap: 6px;
	padding: 0 0 10px 60px;
	margin-top: -6px;
}

.submenu.open {
	display: flex;
}

.sub-item {
	width: calc(100% - 18px);
	background: transparent;
	border: none;
	color: #fff;
	text-align: left;
	padding: 10px 12px;
	border-radius: 10px;
	font-size: 16px;
	cursor: pointer;
	transition: background .15s ease;
}

.sub-item:hover {
	background: rgba(255, 255, 255, .14);
}

.sub-item.active {
	background: rgba(255, 255, 255, .18);
	font-weight: 800;
}

/* ===== Content ===== */
.content {
	flex: 1;
	padding: 22px 26px 26px;
	display: flex;
	flex-direction: column;
	min-height: 100vh;
}

/* Topbar */
.topbar {
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 18px;
	padding: 6px 8px 14px;
}

.search {
	flex: 1;
	max-width: 420px;
	position: relative;
}

.search input {
	width: 100%;
	height: 44px;
	border: none;
	outline: none;
	border-radius: 999px;
	background: #e9e7e3;
	padding: 0 16px 0 44px;
	font-size: 16px;
}

.search .s-icon {
	position: absolute;
	left: 14px;
	top: 50%;
	transform: translateY(-50%);
	width: 18px;
	height: 18px;
	opacity: .85;
}

.search .s-icon img {
	width: 18px;
	height: 18px;
	object-fit: contain;
	display: block;
}

.userbox {
	display: flex;
	align-items: center;
	gap: 14px;
	white-space: nowrap;
}

.userbox .hello {
	font-size: 28px;
	font-weight: 500;
}

/* Perfil subir imagen */
.profile {
	width: 44px;
	height: 44px;
	border-radius: 50%;
	background: #fff;
	border: 2px solid #000;
	overflow: hidden;
	display: grid;
	place-items: center;
	cursor: pointer;
	padding: 0;
}

.profile img {
	width: 100%;
	height: 100%;
	object-fit: cover;
	display: block;
}

/* Panel gris */
.panel {
	background: var(--panel);
	border-radius: var(--radius);
	padding: 24px 26px;
	flex: 1;
	min-height: 0;
}

.panel-head {
	display: flex;
	align-items: flex-start;
	justify-content: space-between;
	gap: 14px;
	margin-bottom: 10px;
}

.panel-title {
	font-size: 22px;
	font-weight: 800;
	margin: 0;
}

.panel-sub {
	margin-top: 18px;
	color: var(--muted);
	font-size: 16px;
}

/* Botón agregar */
.add-btn {
	width: 44px;
	height: 44px;
	border-radius: 50%;
	border: none;
	background: var(--orange);
	cursor: pointer;
	display: grid;
	place-items: center;
	box-shadow: 0 6px 18px rgba(0, 0, 0, .12);
}

.add-btn img {
	width: 24px;
	height: 24px;
	object-fit: contain;
	filter: brightness(0) invert(1);
}

.add-btn:hover {
	background: var(--orange-2);
}

/* ====== NUEVO: Tabla de pendientes ====== */
.pendientes-wrap {
	margin-top: 18px;
	background: rgba(255, 255, 255, .55);
	border-radius: 18px;
	padding: 16px;
}

.pendientes-title {
	font-size: 16px;
	font-weight: 900;
	margin: 0 0 10px;
}

.pendientes-note {
	margin: 0 0 12px;
	color: var(--muted);
	font-size: 13px;
	font-weight: 600;
}

.table {
	width: 100%;
	border-collapse: collapse;
	overflow: hidden;
	border-radius: 14px;
	background: rgba(255, 255, 255, .8);
}

.table th, .table td {
	padding: 10px 10px;
	text-align: left;
	font-size: 13px;
}

.table th {
	background: rgba(198, 106, 0, .18);
	font-weight: 900;
}

.table tr+tr td {
	border-top: 1px solid rgba(0, 0, 0, .06);
}

.table-wrap{
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 14px;
}

/* en pantallas pequeñas permite “scroll” sin aplastar */
@media (max-width: 768px){
  .table{
    min-width: 720px; /* puedes subir/bajar: 650-900 */
  }

  .table th, .table td{
    white-space: nowrap;
  }
}

.role-select {
	height: 36px;
	border-radius: 999px;
	border: 1px solid rgba(0, 0, 0, .12);
	padding: 0 12px;
	background: #fff;
	font-weight: 700;
}

.approve-btn {
	height: 36px;
	border: none;
	border-radius: 999px;
	padding: 0 14px;
	background: var(--orange);
	color: #fff;
	font-weight: 900;
	cursor: pointer;
}

.approve-btn:hover {
	background: var(--orange-2);
}

.badge {
	display: inline-block;
	padding: 6px 10px;
	border-radius: 999px;
	background: rgba(0, 0, 0, .08);
	font-weight: 800;
	font-size: 12px;
	color: #333;
}

.reject-btn {
	height: 36px;
	border: none;
	border-radius: 999px;
	padding: 0 14px;
	background: #b00020;
	color: #fff;
	font-weight: 900;
	cursor: pointer;
}

.reject-btn:hover {
	filter: brightness(1.05);
}
/* ===== Responsive ===== */
@media ( max-width : 1024px) {
	.sidebar {
		width: 260px;
	}
	.userbox .hello {
		font-size: 22px;
	}
	.brand .logo {
		width: 110px;
		height: 110px;
	}
}

/* ===== Móvil ===== */
@media ( max-width : 768px) {
	.layout {
		flex-direction: column;
	}
	.sidebar {
		width: 100%;
		padding: 12px 14px;
		flex-direction: row;
		align-items: center;
		justify-content: space-between;
		gap: 10px;
		position: sticky;
		top: 0;
		z-index: 50;
	}
	.mobile-top {
		display: flex;
	}
	.brand {
		padding: 0;
	}
	.brand .logo {
		width: 56px;
		height: 56px;
		border: 3px solid #fff;
		outline: 2px solid rgba(255, 255, 255, .20);
		box-shadow: 0 8px 18px rgba(0, 0, 0, .16);
	}
	.nav {
		display: none;
		position: absolute;
		left: 0;
		top: 78px;
		width: 100%;
		background: var(--orange);
		padding: 10px 10px 14px;
		gap: 6px;
		flex-direction: column;
	}
	.sidebar.menu-open .nav {
		display: flex;
	}
	.nav-item {
		border-radius: 12px;
		padding: 14px 14px;
	}
	.nav-item .label {
		display: block;
	}
	.submenu {
		position: static;
		padding: 0 0 10px 52px;
		background: transparent;
		border-radius: 0;
	}
	.content {
		padding: 14px;
		min-height: calc(100vh - 80px);
	}
	.topbar {
		flex-direction: column;
		align-items: stretch;
		gap: 10px;
		padding: 10px 6px 12px;
	}
	.search {
		max-width: 100%;
	}
	.userbox {
		justify-content: space-between;
		width: 100%;
	}
	.userbox .hello {
		font-size: 20px;
	}
	.panel {
		border-radius: 22px;
	}
}
</style>
</head>

<body>
	<div class="layout">

		<!-- ===== SIDEBAR ===== -->
		<aside class="sidebar" id="sidebar">
			<div class="brand">
				<div class="logo">
					<img th:src="@{/assets/logo.jpg}" alt="Logo">
				</div>
			</div>

			<!-- botón ☰ solo para móvil -->
			<div class="mobile-top">
				<button class="hamburger" id="btnMenu" type="button"
					aria-label="Abrir menú">☰</button>
			</div>

			<nav class="nav" aria-label="Menú Admin">

				<!-- Proyectos -->
				<button class="nav-item" id="navProyectos" type="button"
					data-view="proyectos">
					<span class="icon"> <img
						th:src="@{/assets/iconos/proyectos.png}" alt="">
					</span> <span class="label">Proyectos</span>
				</button>

				<!-- Usuarios -->
<button class="nav-item"
        id="navUsuarios"
        type="button"
        th:classappend="${#strings.startsWith(view,'usuarios-')} ? ' active' : ''"
        th:attr="data-open=${#strings.startsWith(view,'usuarios-')} ? 'true' : 'false'">
  <span class="icon"><img th:src="@{/assets/iconos/usuarios.png}" alt=""></span>
  <span class="label">Usuarios</span>
  <span class="chev" aria-hidden="true">
    <img th:src="@{/assets/iconos/desplegable.png}" alt="">
  </span>
</button>


<div class="submenu" id="submenuUsuarios" th:classappend="${#strings.startsWith(view,'usuarios-')} ? ' open' : ''">
  <a class="sub-item" data-view="usuarios-supervisores"
  th:classappend="${view=='usuarios-supervisores'} ? ' active' : ''"
  th:href="@{/admin(view='usuarios-supervisores')}">Supervisores</a>

  <a class="sub-item" data-view="usuarios-constructores"
  th:classappend="${view=='usuarios-constructores'} ? ' active' : ''"
  th:href="@{/admin(view='usuarios-constructores')}">Constructores</a>

  <a class="sub-item" data-view="usuarios-directores"
  th:classappend="${view=='usuarios-directores'} ? ' active' : ''"
  th:href="@{/admin(view='usuarios-directores')}">Directores</a>

  <a class="sub-item" data-view="usuarios-central"
  th:classappend="${view=='usuarios-central'} ? ' active' : ''"
  th:href="@{/admin(view='usuarios-central')}">Central</a>

  <a class="sub-item" data-view="usuarios-administrador"
  th:classappend="${view=='usuarios-administrador'} ? ' active' : ''"
  th:href="@{/admin(view='usuarios-administrador')}">Administrador</a>
</div>

				<!-- Solicitudes pendientes -->
				<button class="nav-item" id="navSolicitudes" type="button"
					data-view="solicitudes">
					<span class="icon"> <img
						th:src="@{/assets/iconos/usuario_pendiente.png}" alt="">
					</span> <span class="label">Solicitudes pendientes</span>
				</button>

				<!-- Cerrar sesión -->
				<form th:action="@{/logout}" method="post" style="margin: 0;">
					<input type="hidden" th:name="${_csrf.parameterName}"
						th:value="${_csrf.token}" />
					<button class="nav-item" id="navLogout" type="submit">
						<span class="icon"> <img
							th:src="@{/assets/iconos/salir.png}" alt="">
						</span> <span class="label">Cerrar Sesión</span>
					</button>
				</form>

			</nav>
		</aside>

		<!-- ===== CONTENT ===== -->
		<main class="content">

			<header class="topbar">
				<!-- Buscador visual -->
				<div class="search" role="search">
					<span class="s-icon" aria-hidden="true"> <img
						th:src="@{/assets/iconos/buscar.png}" alt="">
					</span> <input id="searchInput" type="search" placeholder="Buscar..."
						autocomplete="off"
						aria-label="Buscar por nombre, apellidos, proyecto, etc." />
				</div>

				<!-- Saludo en el Perfil -->
				<div class="userbox">
					<div class="hello">
						Hola, <span th:text="${nombreUsuario}">Usuario</span>!
						<div
							style="font-size: 14px; font-weight: 600; color: #6c6c6c; margin-top: 4px;">
							Rol: <span th:text="${rolUsuario}">administrador</span>
						</div>
					</div>

					<input id="profileFile" type="file" accept="image/*" hidden>

					<button class="profile" id="profileBtn" type="button"
						title="Cambiar foto">
						<img id="profileImg" alt="Foto de perfil" style="display: none;">
						<img id="profileFallback" th:src="@{/assets/iconos/usuarios.png}"
							alt="">
					</button>
				</div>
			</header>

			<section class="panel" aria-label="Sección principal">
  <div class="panel-head">
    <div>
      <h2 class="panel-title" id="sectionTitle"
    th:text="${ view=='proyectos' ? 'Proyectos' :
              view=='pendientes' ? 'Solicitudes pendientes' :
              view=='usuarios-supervisores' ? 'Supervisores' :
              view=='usuarios-constructores' ? 'Constructores' :
              view=='usuarios-directores' ? 'Directores' :
              view=='usuarios-central' ? 'Central' :
              view=='usuarios-administrador' ? 'Administrador' :
              'Proyectos' }">
  Supervisores
</h2>
    </div>

    <button class="add-btn" type="button" id="btnAdd" title="Agregar">
      <img th:src="@{/assets/iconos/agregar-usuario.png}" alt="">
    </button>
  </div>

  <div id="panelContent">

    <!-- Mensaje vacío -->
    <div class="panel-sub" th:if="${#lists.isEmpty(usuarios) and #strings.startsWith(view,'usuarios-')}">
      No se ha registrado ningún usuario
    </div>

    <!-- Tabla usuarios -->
    <div th:if="${!#lists.isEmpty(usuarios) and #strings.startsWith(view,'usuarios-')}" style="margin-top:14px;">
      <div class="table-wrap">
      <table class="table">
        <thead>
        <tr>
          <th>ID</th><th>Nombre</th><th>Username</th><th>Email</th><th>Rol</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="u : ${usuarios}">
          <td th:text="${u.idUsuario}">1</td>
          <td th:text="${u.nombre + ' ' + u.apellido}">Nombre Apellido</td>
          <td th:text="${u.username}">usuario</td>
          <td th:text="${u.email}">correo@mail.com</td>
          <td th:text="${u.rol != null ? u.rol.nombre : 'sin rol'}">rol</td>
        </tr>
        </tbody>
      </table>
    </div>

    <div class="pendientes-wrap" id="pendientesWrap"
         th:style="${view=='pendientes'} ? '' : 'display:none;'">

      <p class="pendientes-note">
        Selecciona un rol y aprueba al usuario. Hasta que lo apruebes, <b>no podrá iniciar sesión</b>.
      </p>

      <div th:if="${#lists.isEmpty(pendientes)}" class="badge">
        No hay solicitudes pendientes.
      </div>

      <table class="table" th:if="${!#lists.isEmpty(pendientes)}">
   
      </table>
    </div>

  </div>
</section>

		</main>
	</div>

	<script>
  // ===== Helpers =====
  function getParam(name){
    return new URLSearchParams(window.location.search).get(name);
  }

  function setActiveNav(buttonId){
    document.querySelectorAll('.nav .nav-item').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById(buttonId);
    btn?.classList.add('active');
  }

  function setActiveSubItem(clicked){
    document.querySelectorAll('#submenuUsuarios .sub-item').forEach(x => x.classList.remove('active'));
    clicked?.classList.add('active');
  }

  // ===== Elementos =====
  const sectionTitle   = document.getElementById('sectionTitle');
  const panelContent   = document.getElementById('panelContent');
  const navUsuarios    = document.getElementById('navUsuarios');
  const submenuUsuarios= document.getElementById('submenuUsuarios');

  // ===== Cargar vista sin recargar y sin parpadeo =====
  async function loadPanelFromUrl(href, push = true){
    if(!panelContent){
      window.location.href = href;
      return;
    }

   
    panelContent.innerHTML = `<div class="panel-sub">Cargando...</div>`;

    try{
      const res = await fetch(href, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);

      const html = await res.text();
      const doc  = new DOMParser().parseFromString(html, "text/html");

      const newPanelContent = doc.getElementById("panelContent");
      const newTitle = doc.getElementById("sectionTitle")?.textContent?.trim();

      if(!newPanelContent){
        window.location.href = href;
        return;
      }

      panelContent.innerHTML = newPanelContent.innerHTML;
      if(newTitle && sectionTitle) sectionTitle.textContent = newTitle;

      if(push) history.pushState({ href }, "", href);

      closeMobileMenu();
    }catch(e){
      window.location.href = href;
    }
  }

  // ===== Submenu Usuarios open/close =====
  navUsuarios?.addEventListener('click', () => {
    const isOpen = navUsuarios.getAttribute('data-open') === 'true';
    navUsuarios.setAttribute('data-open', String(!isOpen));
    submenuUsuarios?.classList.toggle('open', !isOpen);
    setActiveNav('navUsuarios');
  });

  // ===== Proyectos =====
  document.getElementById('navProyectos')?.addEventListener('click', (ev) => {
    ev.preventDefault?.();
    setActiveNav('navProyectos');
    loadPanelFromUrl('/admin?view=proyectos', true);
  });

  // ===== Pendientes =====
  document.getElementById('navSolicitudes')?.addEventListener('click', (ev) => {
    ev.preventDefault?.();
    setActiveNav('navSolicitudes');
    loadPanelFromUrl('/admin?view=pendientes', true);
  });

  // ===== Subitems Usuarios =====
  document.querySelectorAll('#submenuUsuarios .sub-item').forEach(a => {
    a.addEventListener('click', (ev) => {
      ev.preventDefault();

      const href = a.getAttribute('href');
      if(!href) return;

      setActiveNav('navUsuarios');
      setActiveSubItem(a);

      navUsuarios?.setAttribute('data-open','true');
      submenuUsuarios?.classList.add('open');

      loadPanelFromUrl(href, true);
    });
  });

  // ===== Back/Forward =====
  window.addEventListener('popstate', (e) => {
    const href = (e.state && e.state.href) ? e.state.href : window.location.href;
    loadPanelFromUrl(href, false);
  });

  // ===== Foto de perfil =====
  const profileBtn = document.getElementById('profileBtn');
  const profileFile = document.getElementById('profileFile');
  const profileImg = document.getElementById('profileImg');
  const profileFallback = document.getElementById('profileFallback');

  profileBtn?.addEventListener('click', () => profileFile?.click());
  profileFile?.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const url = URL.createObjectURL(file);
    profileImg.src = url;
    profileImg.style.display = 'block';
    profileFallback.style.display = 'none';
  });

  // ===== Menú móvil =====
  const btnMenu = document.getElementById('btnMenu');
  const sidebar = document.getElementById('sidebar');

  btnMenu?.addEventListener('click', () => sidebar?.classList.toggle('menu-open'));

  function closeMobileMenu(){
    if(window.matchMedia("(max-width: 768px)").matches){
      sidebar?.classList.remove('menu-open');
    }
  }

  // Botón agregar todavía sin función
  document.getElementById('btnAdd')?.addEventListener('click', () => {});

  // ===== Vista inicial (solo activa estilos) =====
  const v = getParam('view') || 'proyectos';
  if(v === 'pendientes'){
    setActiveNav('navSolicitudes');
  } else if(v.startsWith('usuarios-')){
    setActiveNav('navUsuarios');
    navUsuarios?.setAttribute('data-open','true');
    submenuUsuarios?.classList.add('open');
    const link = document.querySelector(`#submenuUsuarios .sub-item[data-view="${v}"]`);
    setActiveSubItem(link);
  } else {
    setActiveNav('navProyectos');
  }

  // ===== Aprobar usuario (pendientes) =====
  function aprobarUsuario(btn){
    const id = btn.getAttribute('data-id');
    const sel = document.getElementById('rol-' + id);
    if(!sel.checkValidity()){
      sel.reportValidity();
      return;
    }
    document.getElementById('rolHidden-' + id).value = sel.value;
    document.getElementById('aprobar-' + id).submit();
  }
  window.aprobarUsuario = aprobarUsuario; 
</script>
</body>
</html>
